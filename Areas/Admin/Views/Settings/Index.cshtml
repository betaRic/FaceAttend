@model FaceAttend.Areas.Admin.Models.SettingsVm
@{
    ViewBag.Title = "Settings";
}

<div class="ea-page">

    <div class="ea-page-header">
        <div>
            <h1 class="ea-page-title">
                <i class="fa-solid fa-gear" aria-hidden="true"></i>
                Settings
            </h1>
            <div class="ea-page-subtitle">Override web.config values. Changes apply immediately across kiosk and admin.</div>
        </div>
        <div class="ea-page-actions">
            <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">
                <i class="fa-solid fa-gauge-high me-1" aria-hidden="true"></i>Dashboard
            </a>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.WarningMessage))
    {
        <div class="ea-alert warning mb-3">
            <i class="fa-solid fa-triangle-exclamation fa-sm" aria-hidden="true"></i>
            @Model.WarningMessage
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.SavedMessage))
    {
        <div class="ea-alert success mb-3">
            <i class="fa-solid fa-circle-check fa-sm" aria-hidden="true"></i>
            @Model.SavedMessage
        </div>
    }

    @using (Html.BeginForm("Save", "Settings", new { area = "Admin" }, FormMethod.Post))
    {
        @Html.AntiForgeryToken()

        <div class="ea-form-card">
            <div class="ea-form-header">
                <div class="ea-form-title">
                    <i class="fa-solid fa-sliders" aria-hidden="true"></i>
                    System Configuration
                </div>
            </div>
            <div class="ea-form-body">

                <div class="row g-4">

                    @* -- Column 1: Biometrics + Attendance -- *@
                    <div class="col-12 col-lg-6">

                        <div class="ea-settings-section">
                            <div class="ea-settings-section-head">
                                <i class="fa-solid fa-face-smile" aria-hidden="true"></i>
                                Biometrics
                            </div>
                            <div class="ea-settings-section-body">
                                <div class="row g-3">
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.DlibTolerance, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.DlibTolerance, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", step = "0.01", min = "0.20", max = "1.00"
                                        })
                                        @Html.ValidationMessageFor(m => m.DlibTolerance, "", new { @class = "text-danger small" })
                                        <div class="form-text">Lower = stricter. Typical: 0.55-0.65.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.LivenessThreshold, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.LivenessThreshold, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", step = "0.01", min = "0", max = "1"
                                        })
                                        @Html.ValidationMessageFor(m => m.LivenessThreshold, "", new { @class = "text-danger small" })
                                        <div class="form-text">Higher = stricter anti-spoof.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.MinGapSeconds, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.MinGapSeconds, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", min = "1", max = "600"
                                        })
                                        @Html.ValidationMessageFor(m => m.MinGapSeconds, "", new { @class = "text-danger small" })
                                        <div class="form-text">Minimum seconds between scans.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ea-settings-section">
                            <div class="ea-settings-section-head">
                                <i class="fa-solid fa-clock" aria-hidden="true"></i>
                                Attendance Policy
                            </div>
                            <div class="ea-settings-section-body">
                                <div class="row g-3">
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.WorkStart, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.WorkStart, new { @class = "form-control form-control-sm", type = "time" })
                                        @Html.ValidationMessageFor(m => m.WorkStart, "", new { @class = "text-danger small" })
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.WorkEnd, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.WorkEnd, new { @class = "form-control form-control-sm", type = "time" })
                                        @Html.ValidationMessageFor(m => m.WorkEnd, "", new { @class = "text-danger small" })
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.LunchStart, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.LunchStart, new { @class = "form-control form-control-sm", type = "time" })
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.LunchEnd, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.LunchEnd, new { @class = "form-control form-control-sm", type = "time" })
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.FlexiRequiredHours, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.FlexiRequiredHours, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", step = "0.5", min = "1", max = "12"
                                        })
                                        @Html.ValidationMessageFor(m => m.FlexiRequiredHours, "", new { @class = "text-danger small" })
                                        <div class="form-text">Required hours for flexi employees.</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            @Html.CheckBoxFor(m => m.NoGracePeriod, new { @class = "form-check-input", id = "NoGracePeriod" })
                                            <label class="form-check-label small" for="NoGracePeriod">
                                                No grace period (any time after work start is late)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    @* -- Column 2: Location + Review + Visitors -- *@
                    <div class="col-12 col-lg-6">

                        <div class="ea-settings-section">
                            <div class="ea-settings-section-head">
                                <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                                Location &amp; Wi-Fi
                            </div>
                            <div class="ea-settings-section-body">
                                <div class="row g-3">
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.GPSRadiusDefault, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.GPSRadiusDefault, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", min = "10", max = "10000"
                                        })
                                        @Html.ValidationMessageFor(m => m.GPSRadiusDefault, "", new { @class = "text-danger small" })
                                        <div class="form-text">Default radius in meters per office.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.FallbackOfficeId, new { @class = "form-label" })
                                        @Html.DropDownListFor(m => m.FallbackOfficeId,
                                            Model.OfficeOptions,
                                            "-- None --",
                                            new { @class = "form-select form-select-sm" })
                                        <div class="form-text">Used when GPS does not match any office.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ea-settings-section">
                            <div class="ea-settings-section-head">
                                <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                                Review Queue Thresholds
                            </div>
                            <div class="ea-settings-section-body">
                                <div class="row g-3">
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.NeedsReviewNearMatchRatio, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.NeedsReviewNearMatchRatio, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", step = "0.01", min = "0.50", max = "0.99"
                                        })
                                        @Html.ValidationMessageFor(m => m.NeedsReviewNearMatchRatio, "", new { @class = "text-danger small" })
                                        <div class="form-text">Flag low-confidence face matches.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.NeedsReviewLivenessMargin, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.NeedsReviewLivenessMargin, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", step = "0.01", min = "0", max = "0.20"
                                        })
                                        @Html.ValidationMessageFor(m => m.NeedsReviewLivenessMargin, "", new { @class = "text-danger small" })
                                        <div class="form-text">Flag near-threshold liveness scores.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.NeedsReviewGpsMargin, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.NeedsReviewGpsMargin, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", min = "0", max = "200"
                                        })
                                        @Html.ValidationMessageFor(m => m.NeedsReviewGpsMargin, "", new { @class = "text-danger small" })
                                        <div class="form-text">Flag records near the GPS radius boundary.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ea-settings-section">
                            <div class="ea-settings-section-head">
                                <i class="fa-solid fa-user-check" aria-hidden="true"></i>
                                Visitor Retention
                            </div>
                            <div class="ea-settings-section-body">
                                <div class="row g-3">
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.VisitorMaxRecords, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.VisitorMaxRecords, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", min = "100", max = "500000"
                                        })
                                        @Html.ValidationMessageFor(m => m.VisitorMaxRecords, "", new { @class = "text-danger small" })
                                        <div class="form-text">Max visitor log records. Default: 10,000.</div>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        @Html.LabelFor(m => m.VisitorRetentionYears, new { @class = "form-label" })
                                        @Html.TextBoxFor(m => m.VisitorRetentionYears, new {
                                            @class = "form-control form-control-sm",
                                            type = "number", min = "1", max = "20", step = "1"
                                        })
                                        @Html.ValidationMessageFor(m => m.VisitorRetentionYears, "", new { @class = "text-danger small" })
                                        <div class="form-text">
                                            Logs older than this are deleted on cleanup.
                                            Run from the <a href="@Url.Action("Index", "Visitors", new { area = "Admin" })">Visitors page</a>.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            </div>

            <div class="ea-form-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-floppy-disk me-1" aria-hidden="true"></i>Save Settings
                </button>
                <a class="btn btn-outline-secondary" href="@Url.Action("Index")">
                    <i class="fa-solid fa-rotate me-1" aria-hidden="true"></i>Reload
                </a>
                <a class="btn btn-outline-primary" href="@Url.Action("Index", "Attendance", new { area = "Admin" })">
                    <i class="fa-solid fa-clock me-1" aria-hidden="true"></i>Attendance
                </a>
            </div>
        </div>
    }

</div>

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
}
