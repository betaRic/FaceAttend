@model System.Collections.Generic.List<FaceAttend.Areas.Admin.Models.VisitorLogRowVm>
@{
    ViewBag.Title = "Visitor Logs";

    var officeOptions = ViewBag.OfficeOptions as System.Collections.Generic.List<System.Web.Mvc.SelectListItem>;
    var from          = (ViewBag.From      as string) ?? "";
    var to            = (ViewBag.To        as string) ?? "";
    var q             = (ViewBag.Query     as string) ?? "";
    var officeId      = ViewBag.OfficeId;
    var knownOnly     = (bool)(ViewBag.KnownOnly ?? false);

    var exportUrl   = Url.Action("ExportLogsCsv", new { from, to, officeId, q, knownOnly });
    var profilesUrl = Url.Action("Index", "Visitors", new { area = "Admin" });

    bool hasRows = Model != null && Model.Any();
}

<div class="ea-page">

    <div class="ea-page-header">
        <div>
            <h1 class="ea-page-title">
                <i class="fa-solid fa-user-check" aria-hidden="true"></i>
                Visitors
            </h1>
            <div class="ea-page-subtitle">Walk-in visitor face enrollment and log management</div>
        </div>
        <div class="ea-page-actions">
            <a class="btn btn-primary btn-sm" href="@profilesUrl">
                <i class="fa-solid fa-user-plus me-1" aria-hidden="true"></i>Add Visitor
            </a>
        </div>
    </div>

    @* -- Tabs -- *@
    <div class="ea-tabs">
        <a class="ea-tab" href="@profilesUrl">
            <i class="fa-solid fa-users" aria-hidden="true"></i>
            Visitor Profiles
        </a>
        <a class="ea-tab active" href="@Url.Action("Logs")" aria-current="page">
            <i class="fa-solid fa-clipboard-list" aria-hidden="true"></i>
            Visit Logs
            @if (hasRows)
            {
                <span class="badge bg-primary ms-1" style="font-size:.68rem;">@Model.Count</span>
            }
        </a>
    </div>

    @* -- Flash message -- *@
    @if (TempData["msg"] != null)
    {
        string msgKind = (TempData["msgKind"] as string) ?? "success";
        <div class="ea-alert @msgKind mb-3">
            <i class="fa-solid @(msgKind == "success" ? "fa-circle-check" : "fa-triangle-exclamation") fa-sm" aria-hidden="true"></i>
            @TempData["msg"]
        </div>
    }

    @* -- Filter card -- *@
    <div class="ea-filter-card">
        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <a class="btn btn-outline-primary btn-sm" href="@exportUrl" target="_blank">
                <i class="fa-solid fa-file-export me-1" aria-hidden="true"></i>Export CSV
            </a>
            @using (Html.BeginForm("Purge", "Visitors", new { area = "Admin" }, FormMethod.Post, new { @class = "d-inline" }))
            {
                @Html.AntiForgeryToken()
                <button class="btn btn-outline-danger btn-sm" type="submit"
                        data-confirm="Purge old visitor logs?"
                        data-confirm-text="This permanently deletes log entries older than the retention setting. Visitor profiles are not deleted."
                        data-confirm-icon="warning">
                    <i class="fa-solid fa-trash-can me-1" aria-hidden="true"></i>Purge old logs
                </button>
            }
        </div>

        <form method="get" action="@Url.Action("Logs")" class="row g-2 align-items-end">
            <div class="col-12 col-sm-6 col-md-2">
                <label class="ea-filter-label">From</label>
                <input class="form-control form-control-sm" name="from" type="date" value="@from" />
            </div>
            <div class="col-12 col-sm-6 col-md-2">
                <label class="ea-filter-label">To</label>
                <input class="form-control form-control-sm" name="to" type="date" value="@to" />
            </div>
            <div class="col-12 col-sm-6 col-md-2">
                <label class="ea-filter-label">Office</label>
                @Html.DropDownList("officeId", officeOptions, new { @class = "form-select form-select-sm" })
            </div>
            <div class="col-12 col-sm-6 col-md-3">
                <label class="ea-filter-label">Search</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fa-solid fa-magnifying-glass text-muted" aria-hidden="true"></i>
                    </span>
                    <input class="form-control border-start-0 ps-0" name="q" value="@q" placeholder="Name or purpose..." />
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-2">
                <label class="ea-filter-label">Visitor type</label>
                <select class="form-select form-select-sm" name="knownOnly">
                    <option value="false" @(!knownOnly ? "selected" : "")>All visitors</option>
                    <option value="true"  @(knownOnly  ? "selected" : "")>Enrolled only</option>
                </select>
            </div>
            <div class="col-12 col-sm-auto ms-sm-auto">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm px-3" type="submit">
                        <i class="fa-solid fa-filter me-1" aria-hidden="true"></i>Apply
                    </button>
                    <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("Logs")">
                        <i class="fa-solid fa-rotate" aria-hidden="true"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>

    @* -- Table card -- *@
    <div class="ea-table-card">
        <div class="ea-table-header">
            <div class="ea-table-title">
                <i class="fa-solid fa-clipboard-list text-primary" aria-hidden="true"></i>
                Visit Logs
            </div>
            @if (hasRows)
            {
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle" style="font-size:.75rem;">
                    @Model.Count log@(Model.Count == 1 ? "" : "s")
                </span>
            }
        </div>

        <div class="table-responsive">
            @if (!hasRows)
            {
                <div class="ea-empty">
                    <i class="fa-solid fa-clipboard" aria-hidden="true"></i>
                    <div class="ea-empty-title">No visit logs found</div>
                    <div class="ea-empty-desc">Try adjusting the date range or filters.</div>
                </div>
            }
            else
            {
                <table class="ea-table table table-hover align-middle mb-0 js-datatable"
                       data-dt-page-length="25">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Visitor</th>
                            <th>Enrolled</th>
                            <th>Office</th>
                            <th>Purpose</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in Model)
                        {
                            var localTs = r.TimestampUtc.ToLocalTime();
                            <tr>
                                <td style="white-space:nowrap;">
                                    <div class="fw-semibold" style="font-size:.85rem;">@localTs.ToString("HH:mm")</div>
                                    <div class="ea-cell-muted">@localTs.ToString("MMM d, yyyy")</div>
                                </td>
                                <td>
                                    <div class="fw-semibold" style="font-size:.875rem;">@r.VisitorName</div>
                                </td>
                                <td>
                                    @if (r.IsKnown)
                                    {
                                        <span class="ea-badge enrolled">
                                            <i class="fa-solid fa-face-smile fa-xs"></i>Yes
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="ea-badge secondary">
                                            <i class="fa-solid fa-user fa-xs"></i>Walk-in
                                        </span>
                                    }
                                </td>
                                <td class="ea-cell-muted" style="font-size:.82rem;">@r.OfficeName</td>
                                <td style="font-size:.82rem; max-width:220px;">
                                    @(string.IsNullOrWhiteSpace(r.Purpose) ? "-" : r.Purpose)
                                </td>
                                <td class="ea-cell-muted" style="font-size:.78rem;">
                                    <code>@r.Source</code>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        @if (hasRows)
        {
            <div class="ea-table-footer">
                <div class="ea-table-info">
                    @Model.Count log@(Model.Count == 1 ? "" : "s") shown.
                    Capped at 5,000 rows &mdash; use date filters or export for larger ranges.
                </div>
                <a class="ea-table-info text-decoration-none" href="@exportUrl" target="_blank">
                    <i class="fa-solid fa-file-export me-1" aria-hidden="true"></i>Export CSV
                </a>
            </div>
        }
    </div>

</div>
